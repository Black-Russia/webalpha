// --- TRANSLATIONS ---
const T = {
    kz: {
        announcement: "–¢–ï–ì–Ü–ù –ñ–ï–¢–ö–Ü–ó–£ 15 000 ‚Ç∏ –ê–°–¢–ê–ú –¢–ê–ü–°–´–†–´–°–¢–ê–†“í–ê",
        heroTitle: "–ñ–∞“£–∞ –ö–æ–ª–ª–µ–∫—Ü–∏—è 2026",
        heroSub: "–°–∞–ø–∞–ª—ã –∫–∏—ñ–º. ALPHARAON —Ç–∞“£–¥–∞—É—ã.",
        sectionTitle: "–ë–∞—Ä–ª—ã“õ —Ç–∞—É–∞—Ä–ª–∞—Ä",
        loading: "–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...",
        noItems: "–¢–∞—É–∞—Ä–ª–∞—Ä –∂–æ“õ",
        selectSize: "”®–ª—à–µ–º–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑!",
        buyNow: "–°–∞—Ç—ã–ø –∞–ª—É",
        outOfStock: "–°–∞—Ç—ã–ª—ã–º–¥–∞ –∂–æ“õ",
        lowStock: "–ê–∑ “õ–∞–ª–¥—ã",
        sizeGuide: "”®–ª—à–µ–º –∫–µ—Å—Ç–µ—Å—ñ",
        cityTitle: "“ö–∞–ª–∞–Ω—ã —Ç–∞“£–¥–∞“£—ã–∑",
        cityNote: "*15 000‚Ç∏ –∞—Å—Ç–∞–º - –ê—Å—Ç–∞–Ω–∞/–ê–ª–º–∞—Ç—ã —Ç–µ–≥—ñ–Ω",
        otherCity: "–ë–∞—Å“õ–∞ “õ–∞–ª–∞",
        cartTitle: "–°–µ–±–µ—Ç",
        addToCart: "–°–µ–±–µ—Ç–∫–µ —Å–∞–ª—É",
        checkout: "–¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É",
        total: "–ë–∞—Ä–ª—ã“ì—ã",
        emptyCart: "–°–µ–±–µ—Ç –±–æ—Å",
        addedToCart: "–°–µ–±–µ—Ç–∫–µ “õ–æ—Å—ã–ª–¥—ã!",
        cities: {
            Astana: "–ê—Å—Ç–∞–Ω–∞",
            Almaty: "–ê–ª–º–∞—Ç—ã",
            Karaganda: "“ö–∞—Ä–∞“ì–∞–Ω–¥—ã",
            Shymkent: "–®—ã–º–∫–µ–Ω—Ç",
            Aktobe: "–ê“õ—Ç”©–±–µ",
            Other: "–ë–∞—Å“õ–∞ “õ–∞–ª–∞"
        },
        waGreeting: "–°”ô–ª–µ–º! –¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä–≥—ñ–º –∫–µ–ª–µ–¥—ñ:",
        waSize: "”®–ª—à–µ–º",
        waCity: "“ö–∞–ª–∞",
        waDelivery: "–ñ–µ—Ç–∫—ñ–∑—É",
        waPrice: "–ë–∞“ì–∞—Å—ã",
        oneSize: "–ë—ñ—Ä ”©–ª—à–µ–º",
        footerAbout: "–ë—ñ–∑ —Ç—É—Ä–∞–ª—ã",
        footerPrivacy: "“ö“±–ø–∏—è–ª—ã–ª—ã“õ —Å–∞—è—Å–∞—Ç—ã",
        footerSupport: "“ö–æ–ª–¥–∞—É",
        footerSize: "”®–ª—à–µ–º –∫–µ—Å—Ç–µ—Å—ñ",
        footerShipping: "–ñ–µ—Ç–∫—ñ–∑—É",
        footerFaq: "FAQ",
        footerContact: "–ë–∞–π–ª–∞–Ω—ã—Å",
        sizeTitle: "”®–ª—à–µ–º –∫–µ—Å—Ç–µ—Å—ñ",
        sizeDesc: "Oversize –ø—ñ—à—ñ–º—ñ. –ï—Ä–∫—ñ–Ω –∫–∏—ñ–º “Ø—à—ñ–Ω –±—ñ—Ä ”©–ª—à–µ–º “Ø–ª–∫–µ–Ω –∞–ª—ã“£—ã–∑.",
        thHeight: "–ë–æ–π (—Å–º)",
        thWeight: "–°–∞–ª–º–∞“õ (–∫–≥)",
        thSize: "”®–ª—à–µ–º",
        aboutTitle: "–ë—ñ–∑ —Ç—É—Ä–∞–ª—ã",
        aboutP1: "ALPHARAON 2026 –∂—ã–ª—ã “õ“±—Ä—ã–ª–¥—ã. –ë—ñ–∑–¥—ñ“£ –º–∞“õ—Å–∞—Ç—ã–º—ã–∑ ‚Äî –µ“£ —Å–∞–ø–∞–ª—ã streetwear —Ç–∞—É–∞—Ä–ª–∞—Ä–¥—ã —Ç–∞“£–¥–∞–ø, —Å—ñ–∑–≥–µ “±—Å—ã–Ω—É.",
        aboutP2: "–ë—ñ–∑ —Ç—Ä–µ–Ω–¥—Ç–µ—Ä–¥—ñ —Å–æ“õ—ã—Ä “õ—É–∞–º—ã–∑ –µ–º–µ—Å. –ë—ñ–∑ ”ô—Ä“õ–∞—à–∞–Ω ”©–∑–µ–∫—Ç—ñ, —Å–∞–ø–∞–ª—ã –∫–∏—ñ–º —Ç–∞“£–¥–∞–π–º—ã–∑. –ë—ñ–∑ ”©–∑ —ñ—Å—ñ–º—ñ–∑–¥—ñ —Å“Ø–π–µ–º—ñ–∑.",
        aboutValuesTitle: "–ë—ñ–∑–¥—ñ“£ “õ“±–Ω–¥—ã–ª—ã“õ—Ç–∞—Ä",
        values: ["‚Ä¢ –ê–¥–∞–ª–¥—ã“õ", "‚Ä¢ –°–∞–ø–∞", "‚Ä¢ –î–∞–º—É", "‚Ä¢ –°–µ–Ω—ñ–º"],
        copyright: "¬© 2026 ALPHARAON. –ë–∞—Ä–ª—ã“õ “õ“±“õ—ã“õ—Ç–∞—Ä “õ–æ—Ä“ì–∞–ª“ì–∞–Ω.",
        privacyTitle: "“ö“±–ø–∏—è–ª—ã–ª—ã“õ —Å–∞—è—Å–∞—Ç—ã",
        privacyContent: `<p style="margin-bottom: 16px;">–ë—ñ–∑ —Å—ñ–∑–¥—ñ“£ –∂–µ–∫–µ –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ“£—ñ–∑–¥—ñ “õ–æ—Ä“ì–∞–π–º—ã–∑:</p>
            <ul style="margin-left: 20px; margin-bottom: 16px;">
                <li>–ê—Ç—ã-–∂”©–Ω—ñ“£—ñ–∑ —Ç–µ–∫ —Ç–∞–ø—Å—ã—Ä—ã—Å “Ø—à—ñ–Ω “õ–æ–ª–¥–∞–Ω—ã–ª–∞–¥—ã</li>
                <li>–¢–µ–ª–µ—Ñ–æ–Ω –Ω”©–º—ñ—Ä—ñ“£—ñ–∑ “Ø—à—ñ–Ω—à—ñ —Ç–∞—Ä–∞–ø“õ–∞ –±–µ—Ä—ñ–ª–º–µ–π–¥—ñ</li>
                <li>–¢”©–ª–µ–º –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ —Å–∞“õ—Ç–∞–ª–º–∞–π–¥—ã</li>
            </ul>
            <p>–°“±—Ä–∞“õ—Ç–∞—Ä –±–æ–ª—Å–∞: +7 705 502 01 33</p>`,
        shippingTitle: "–ñ–µ—Ç–∫—ñ–∑—É",
        shippingContent: `<p style="margin-bottom: 12px;"><strong>–ê—Å—Ç–∞–Ω–∞, –ê–ª–º–∞—Ç—ã:</strong> 1-3 –∂“±–º—ã—Å –∫“Ø–Ω—ñ ‚Äî <strong>1 500‚Ç∏</strong></p>
            <p style="margin-bottom: 12px;"><strong>“ö–∞—Ä–∞“ì–∞–Ω–¥—ã, –®—ã–º–∫–µ–Ω—Ç, –ê“õ—Ç”©–±–µ:</strong> 3-5 –∂“±–º—ã—Å –∫“Ø–Ω—ñ ‚Äî <strong>2 000‚Ç∏</strong></p>
            <p style="margin-bottom: 16px;"><strong>–ë–∞—Å“õ–∞ “õ–∞–ª–∞–ª–∞—Ä:</strong> –ü–æ—à—Ç–∞ –∞—Ä“õ—ã–ª—ã 5-10 –∫“Ø–Ω ‚Äî <strong>2 500-3 000‚Ç∏</strong></p>
            <p style="margin-bottom: 12px; color: #666;">15 000‚Ç∏ –∞—Å—Ç–∞–º —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä“ì–∞ –ê—Å—Ç–∞–Ω–∞/–ê–ª–º–∞—Ç—ã –∂–µ—Ç–∫—ñ–∑—É –¢–ï–ì–Ü–ù!</p>
            <p>–°“±—Ä–∞“õ—Ç–∞—Ä –±–æ–π—ã–Ω—à–∞: <a href="https://wa.me/77055020133" style="color:#25D366; font-weight:600;">WhatsApp</a></p>`,
        faqTitle: "–ñ–∏—ñ “õ–æ–π—ã–ª–∞—Ç—ã–Ω —Å“±—Ä–∞“õ—Ç–∞—Ä",
        faqContent: `<p style="font-weight: 600; margin-bottom: 8px;">“ö–∞–ª–∞–π —Ç”©–ª–µ–π–º—ñ–Ω?</p>
            <p style="margin-bottom: 16px; color: #666;">Kaspi –∞—É–¥–∞—Ä—ã–º –Ω–µ–º–µ—Å–µ Kaspi QR –∞—Ä“õ—ã–ª—ã.</p>
            <p style="font-weight: 600; margin-bottom: 8px;">“ö–∞–π—Ç–∞—Ä—É –±–∞—Ä –º–∞?</p>
            <p style="margin-bottom: 16px; color: #666;">–ò”ô, 14 –∫“Ø–Ω —ñ—à—ñ–Ω–¥–µ “õ–∞–π—Ç–∞—Ä—É“ì–∞ –±–æ–ª–∞–¥—ã (—Ç–µ–≥ –∞–ª—ã–Ω–±–∞—Å–∞).</p>
            <p style="font-weight: 600; margin-bottom: 8px;">”®–ª—à–µ–º –¥“±—Ä—ã—Å –∫–µ–ª–º–µ—Å–µ?</p>
            <p style="color: #666;">–ê–ª–º–∞—Å—Ç—ã—Ä—É —Ç–µ–≥—ñ–Ω. WhatsApp-“õ–∞ –∂–∞–∑—ã“£—ã–∑.</p>`,
        reviews: "–ø—ñ–∫—ñ—Ä",
        filterAll: "–ë–∞—Ä–ª—ã“ì—ã",
        filterClothing: "–ö–∏—ñ–º",
        filterAccessory: "–ê–∫—Å–µ—Å—Å—É–∞—Ä",
        specFabric: "–ú–∞—Ç–∞",
        specGsm: "–¢—ã“ì—ã–∑–¥—ã“õ",
        specFit: "–ü—ñ—à—ñ–º",
        specCare: "–ö“Ø—Ç—ñ–º",
        aboutProduct: "–¢–ê–£–ê–† –¢–£–†–ê–õ–´",
        sizeLabel: "”®–ª—à–µ–º:",
        toCart: "–°–ï–ë–ï–¢–ö–ï –°–ê–õ–£",
        newBadge: "–ñ–ê“¢–ê",
        addedToCart: "“ö–æ—Å—ã–ª–¥—ã",
        promoPlaceholder: "–ü—Ä–æ–º–æ–∫–æ–¥",
        discount: "–ñ–µ“£—ñ–ª–¥—ñ–∫",
        invalidPromo: "–ñ–∞—Ä–∞–º—Å—ã–∑ –∫–æ–¥",
        promoApplied: "“ö–æ–ª–¥–∞–Ω—ã–ª–¥—ã"
    },
    ru: {
        announcement: "–ë–ï–°–ü–õ–ê–¢–ù–ê–Ø –î–û–°–¢–ê–í–ö–ê –û–¢ 15 000 ‚Ç∏",
        heroTitle: "–ù–æ–≤–∞—è –ö–æ–ª–ª–µ–∫—Ü–∏—è 2026",
        heroSub: "–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –æ–¥–µ–∂–¥–∞. –í—ã–±–æ—Ä ALPHARAON.",
        sectionTitle: "–í—Å–µ —Ç–æ–≤–∞—Ä—ã",
        loading: "–ó–∞–≥—Ä—É–∑–∫–∞...",
        noItems: "–¢–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç",
        selectSize: "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä!",
        buyNow: "–ö—É–ø–∏—Ç—å",
        outOfStock: "–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏",
        lowStock: "–ú–∞–ª–æ",
        sizeGuide: "–¢–∞–±–ª–∏—Ü–∞ —Ä–∞–∑–º–µ—Ä–æ–≤",
        cityTitle: "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥",
        cityNote: "*–û—Ç 15 000‚Ç∏ - –ê—Å—Ç–∞–Ω–∞/–ê–ª–º–∞—Ç—ã –±–µ—Å–ø–ª–∞—Ç–Ω–æ",
        otherCity: "–î—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥",
        cartTitle: "–ö–æ—Ä–∑–∏–Ω–∞",
        addToCart: "–í –∫–æ—Ä–∑–∏–Ω—É",
        checkout: "–û—Ñ–æ—Ä–º–∏—Ç—å",
        total: "–ò—Ç–æ–≥–æ",
        emptyCart: "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞",
        addedToCart: "–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É!",
        cities: {
            Astana: "–ê—Å—Ç–∞–Ω–∞",
            Almaty: "–ê–ª–º–∞—Ç—ã",
            Karaganda: "–ö–∞—Ä–∞–≥–∞–Ω–¥–∞",
            Shymkent: "–®—ã–º–∫–µ–Ω—Ç",
            Aktobe: "–ê–∫—Ç–æ–±–µ",
            Other: "–î—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥"
        },
        waGreeting: "–ü—Ä–∏–≤–µ—Ç! –•–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å:",
        waSize: "–†–∞–∑–º–µ—Ä",
        waCity: "–ì–æ—Ä–æ–¥",
        waDelivery: "–î–æ—Å—Ç–∞–≤–∫–∞",
        waPrice: "–¶–µ–Ω–∞",
        oneSize: "–û–¥–∏–Ω —Ä–∞–∑–º–µ—Ä",
        footerAbout: "–û –Ω–∞—Å",
        footerPrivacy: "–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏",
        footerSupport: "–ü–æ–¥–¥–µ—Ä–∂–∫–∞",
        footerSize: "–¢–∞–±–ª–∏—Ü–∞ —Ä–∞–∑–º–µ—Ä–æ–≤",
        footerShipping: "–î–æ—Å—Ç–∞–≤–∫–∞",
        footerFaq: "FAQ",
        footerContact: "–ö–æ–Ω—Ç–∞–∫—Ç—ã",
        sizeTitle: "–¢–∞–±–ª–∏—Ü–∞ —Ä–∞–∑–º–µ—Ä–æ–≤",
        sizeDesc: "Oversize –∫—Ä–æ–π. –î–ª—è —Å–≤–æ–±–æ–¥–Ω–æ–π –ø–æ—Å–∞–¥–∫–∏ –±–µ—Ä–∏—Ç–µ –Ω–∞ —Ä–∞–∑–º–µ—Ä –±–æ–ª—å—à–µ.",
        thHeight: "–†–æ—Å—Ç (—Å–º)",
        thWeight: "–í–µ—Å (–∫–≥)",
        thSize: "–†–∞–∑–º–µ—Ä",
        aboutTitle: "–û –Ω–∞—Å",
        aboutP1: "ALPHARAON –±—ã–ª –æ—Å–Ω–æ–≤–∞–Ω –≤ 2026 –≥–æ–¥—É. –ù–∞—à–∞ —Ü–µ–ª—å ‚Äî –æ—Ç–±–∏—Ä–∞—Ç—å –ª—É—á—à–∏–µ streetwear —Ç–æ–≤–∞—Ä—ã –∏ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∏—Ö –≤–∞–º.",
        aboutP2: "–ú—ã –Ω–µ —Å–ª–µ–¥—É–µ–º —Å–ª–µ–ø–æ –∑–∞ —Ç—Ä–µ–Ω–¥–∞–º–∏. –ú—ã –≤—ã–±–∏—Ä–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—É—é –æ–¥–µ–∂–¥—É. –ú—ã –ª—é–±–∏–º —Å–≤–æ—ë –¥–µ–ª–æ.",
        aboutValuesTitle: "–ù–∞—à–∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏",
        values: ["‚Ä¢ –ß–µ—Å—Ç–Ω–æ—Å—Ç—å", "‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–æ", "‚Ä¢ –†–∞–∑–≤–∏—Ç–∏–µ", "‚Ä¢ –î–æ–≤–µ—Ä–∏–µ"],
        copyright: "¬© 2026 ALPHARAON. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.",
        privacyTitle: "–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏",
        privacyContent: `<p style="margin-bottom: 16px;">–ú—ã –∑–∞—â–∏—â–∞–µ–º –≤–∞—à–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</p>
            <ul style="margin-left: 20px; margin-bottom: 16px;">
                <li>–í–∞—à–µ –∏–º—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–∫–∞–∑–∞</li>
                <li>–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º</li>
                <li>–ü–ª–∞—Ç—ë–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</li>
            </ul>
            <p>–í–æ–ø—Ä–æ—Å—ã: +7 705 502 01 33</p>`,
        shippingTitle: "–î–æ—Å—Ç–∞–≤–∫–∞",
        shippingContent: `<p style="margin-bottom: 12px;"><strong>–ê—Å—Ç–∞–Ω–∞, –ê–ª–º–∞—Ç—ã:</strong> 1-3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è ‚Äî <strong>1 500‚Ç∏</strong></p>
            <p style="margin-bottom: 12px;"><strong>–ö–∞—Ä–∞–≥–∞–Ω–¥–∞, –®—ã–º–∫–µ–Ω—Ç, –ê–∫—Ç–æ–±–µ:</strong> 3-5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π ‚Äî <strong>2 000‚Ç∏</strong></p>
            <p style="margin-bottom: 16px;"><strong>–î—Ä—É–≥–∏–µ –≥–æ—Ä–æ–¥–∞:</strong> –ü–æ—á—Ç–æ–π 5-10 –¥–Ω–µ–π ‚Äî <strong>2 500-3 000‚Ç∏</strong></p>
            <p style="margin-bottom: 12px; color: #666;">–ü—Ä–∏ –∑–∞–∫–∞–∑–µ –æ—Ç 15 000‚Ç∏ –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –ê—Å—Ç–∞–Ω–µ/–ê–ª–º–∞—Ç—ã –ë–ï–°–ü–õ–ê–¢–ù–û!</p>
            <p>–í–æ–ø—Ä–æ—Å—ã: <a href="https://wa.me/77055020133" style="color:#25D366; font-weight:600;">WhatsApp</a></p>`,
        faqTitle: "–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã",
        faqContent: `<p style="font-weight: 600; margin-bottom: 8px;">–ö–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å?</p>
            <p style="margin-bottom: 16px; color: #666;">Kaspi –ø–µ—Ä–µ–≤–æ–¥ –∏–ª–∏ Kaspi QR.</p>
            <p style="font-weight: 600; margin-bottom: 8px;">–ï—Å—Ç—å –≤–æ–∑–≤—Ä–∞—Ç?</p>
            <p style="margin-bottom: 16px; color: #666;">–î–∞, –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π (–µ—Å–ª–∏ –±–∏—Ä–∫–∞ –Ω–µ —Å–Ω—è—Ç–∞).</p>
            <p style="font-weight: 600; margin-bottom: 8px;">–ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –Ω–µ –ø–æ–¥–æ—à—ë–ª?</p>
            <p style="color: #666;">–û–±–º–µ–Ω –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π. –ù–∞–ø–∏—à–∏—Ç–µ –≤ WhatsApp.</p>`,
        reviews: "–æ—Ç–∑—ã–≤–æ–≤",
        filterAll: "–í—Å–µ",
        filterClothing: "–û–¥–µ–∂–¥–∞",
        filterAccessory: "–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã",
        specFabric: "–¢–∫–∞–Ω—å",
        specGsm: "–ü–ª–æ—Ç–Ω–æ—Å—Ç—å",
        specFit: "–ö—Ä–æ–π",
        specCare: "–£—Ö–æ–¥",
        aboutProduct: "–û –¢–û–í–ê–†–ï",
        sizeLabel: "–†–∞–∑–º–µ—Ä:",
        toCart: "–í –ö–û–†–ó–ò–ù–£",
        newBadge: "–ù–û–í–ò–ù–ö–ê",
        addedToCart: "–î–æ–±–∞–≤–ª–µ–Ω–æ",
        promoPlaceholder: "–ü—Ä–æ–º–æ–∫–æ–¥",
        discount: "–°–∫–∏–¥–∫–∞",
        invalidPromo: "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥",
        promoApplied: "–ü—Ä–∏–º–µ–Ω–µ–Ω"
    }
};

let currentLang = localStorage.getItem('alpharaon_lang') || null;
let productsData = {};
let selectedSizes = {};
let currentCategory = 'all';
let promoCodes = {};
let activePromo = null;
let cart = JSON.parse(localStorage.getItem('cart') || '[]');

// --- CART COUNT ---
function updateCartCount() {
    const badge = document.getElementById('cart-badge');
    if (badge) {
        badge.innerText = cart.length;
        badge.setAttribute('data-count', cart.length);
    }
}

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    if (currentLang) {
        document.getElementById('lang-modal').style.display = 'none';
        applyLang(currentLang);
    }
    updateCartCount();
    updateMenuLangText();
    updateCityDropdown();
    setTimeout(() => { if (window.db) initStore(); }, 500);
});

// --- LANGUAGE DROPDOWN ---
window.toggleLangDropdown = function () {
    const wrapper = document.getElementById('lang-dropdown-wrapper');
    wrapper.classList.toggle('open');
    // Close city dropdown if open
    document.getElementById('city-dropdown-wrapper').classList.remove('open');
}

window.selectLangFromDropdown = function (lang) {
    currentLang = lang;
    localStorage.setItem('alpharaon_lang', lang);

    // Update display
    const display = document.getElementById('current-lang-display');
    if (display) display.innerText = lang.toUpperCase();

    // Close dropdown
    document.getElementById('lang-dropdown-wrapper').classList.remove('open');

    // Apply language
    applyLang(lang);
    updateCityDropdown(); // Update city text in new language

    // Re-render products
    if (Object.keys(productsData).length > 0) {
        renderGrid();
    }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function (e) {
    const langDropdown = document.getElementById('lang-dropdown-wrapper');
    if (langDropdown && !langDropdown.contains(e.target)) {
        langDropdown.classList.remove('open');
    }
});

// Handle language selection from welcome modal
window.selectLangFromWelcome = function (lang) {
    currentLang = lang;
    localStorage.setItem('alpharaon_lang', lang);

    // Close welcome modal
    document.getElementById('lang-modal').style.display = 'none';

    // Update dropdown display
    const display = document.getElementById('current-lang-display');
    if (display) display.innerText = lang.toUpperCase();

    // Apply language
    applyLang(lang);
    updateCityDropdown();

    // Re-render products
    if (Object.keys(productsData).length > 0) {
        renderGrid();
    }
}

// --- SLIDEOUT MENU ---
let selectedCity = localStorage.getItem('alpharaon_city') || 'Astana';

window.openMenu = function () {
    document.getElementById('side-menu').classList.add('open');
    document.getElementById('menu-overlay').classList.add('open');
    document.body.style.overflow = 'hidden';
}

window.closeMenu = function () {
    document.getElementById('side-menu').classList.remove('open');
    document.getElementById('menu-overlay').classList.remove('open');
    document.body.style.overflow = '';
}

window.openCityModal = function () {
    closeMenu();
    // Switch button handlers to setCity (save preference only)
    const cityBtns = document.querySelectorAll('.city-btn');
    const cities = ['Astana', 'Almaty', 'Karaganda', 'Shymkent', 'Aktobe', 'Other'];
    cityBtns.forEach((btn, i) => {
        btn.onclick = () => setCity(cities[i]);
    });
    document.getElementById('city-modal').style.display = 'flex';
}

window.setCity = function (city) {
    selectedCity = city;
    localStorage.setItem('alpharaon_city', city);
    const t = T[currentLang || 'kz'];
    const cityName = t.cities[city] || city;
    const cityText = document.getElementById('current-city-text');
    if (cityText) cityText.innerText = cityName.toLowerCase();
    closeModal('city-modal');
}

window.scrollToProducts = function () {
    const productsSection = document.querySelector('.products');
    if (productsSection) {
        productsSection.scrollIntoView({ behavior: 'smooth' });
    }
}

// --- CUSTOM CITY DROPDOWN ---
window.toggleCityDropdown = function () {
    const wrapper = document.getElementById('city-dropdown-wrapper');
    wrapper.classList.toggle('open');
}

window.selectCityFromDropdown = function (cityValue, cityLabel) {
    selectedCity = cityValue;
    localStorage.setItem('alpharaon_city', cityValue);

    // Update display text
    const display = document.getElementById('current-city-display');
    if (display) display.innerText = cityLabel;

    // Close dropdown
    document.getElementById('city-dropdown-wrapper').classList.remove('open');
}

// Close dropdown when clicking outside
document.addEventListener('click', function (e) {
    const dropdown = document.getElementById('city-dropdown-wrapper');
    if (dropdown && !dropdown.contains(e.target)) {
        dropdown.classList.remove('open');
    }
});

// Update city display on page load
function updateCityDropdown() {
    const display = document.getElementById('current-city-display');
    if (display && selectedCity) {
        const cityLabels = {
            'Astana': '–ê—Å—Ç–∞–Ω–∞',
            'Almaty': '–ê–ª–º–∞—Ç—ã',
            'Shymkent': '–®—ã–º–∫–µ–Ω—Ç',
            'Other': '–î—Ä—É–≥–æ–π'
        };
        display.innerText = cityLabels[selectedCity] || selectedCity;
    }
}

// --- NEW CHECKOUT FLOW ---
const cityNames = {
    'Astana': '–ê—Å—Ç–∞–Ω–∞',
    'Almaty': '–ê–ª–º–∞—Ç—ã',
    'Shymkent': '–®—ã–º–∫–µ–Ω—Ç',
    'Other': '–î—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥'
};

// Start checkout - show city confirmation
window.startCheckout = function () {
    closeModal('cart-modal');

    // Get translated city names
    const t = T[currentLang || 'kz'];
    const cityName = t.cities[selectedCity] || selectedCity;

    // Update modal text in current language
    const isRu = (currentLang === 'ru');
    document.getElementById('city-confirm-title').innerText = isRu ? '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≥–æ—Ä–æ–¥' : '“ö–∞–ª–∞–Ω—ã —Ä–∞—Å—Ç–∞“£—ã–∑';
    document.getElementById('city-confirm-text').innerHTML = isRu
        ? `–í–∞—à –≥–æ—Ä–æ–¥ <strong id="confirm-city-name">${cityName}</strong>?`
        : `–°—ñ–∑–¥—ñ“£ “õ–∞–ª–∞“£—ã–∑ <strong id="confirm-city-name">${cityName}</strong>?`;

    // Update buttons
    document.querySelector('.btn-confirm-yes').innerText = isRu ? '–î–∞' : '–ò”ô';
    document.querySelector('.btn-confirm-no').innerText = isRu ? '–ù–µ—Ç, –∏–∑–º–µ–Ω–∏—Ç—å' : '–ñ–æ“õ, ”©–∑–≥–µ—Ä—Ç—É';

    document.getElementById('city-confirm-modal').style.display = 'flex';
}

// User confirms city - proceed with order
window.confirmCity = function () {
    closeModal('city-confirm-modal');
    proceedWithOrder(selectedCity);
}

// User wants to change city
window.showCityPicker = function () {
    closeModal('city-confirm-modal');

    // Translate modal content
    const isRu = (currentLang === 'ru');
    const t = T[currentLang || 'kz'];

    // Update title
    const modal = document.getElementById('city-picker-modal');
    const title = modal.querySelector('h3');
    if (title) title.innerText = isRu ? '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥' : '“ö–∞–ª–∞–Ω—ã —Ç–∞“£–¥–∞“£—ã–∑';

    // Update city buttons
    const cityBtns = modal.querySelectorAll('.city-btn');
    const cities = ['Astana', 'Almaty', 'Shymkent', 'Other'];
    cityBtns.forEach((btn, i) => {
        btn.innerText = t.cities[cities[i]] || cities[i];
    });

    document.getElementById('city-picker-modal').style.display = 'flex';
}

// User picks a new city
window.pickCity = function (city) {
    selectedCity = city;
    localStorage.setItem('alpharaon_city', city);
    const citySelect = document.getElementById('city-select');
    if (citySelect) citySelect.value = city;
    closeModal('city-picker-modal');
    proceedWithOrder(city);
}

// Update current language text in menu
function updateMenuLangText() {
    const langText = document.getElementById('current-lang-text');
    if (langText) langText.innerText = (currentLang || 'kz').toUpperCase();
}

// Update current city text in menu
function updateMenuCityText() {
    const t = T[currentLang || 'kz'];
    const cityName = t.cities[selectedCity] || selectedCity;
    const cityText = document.getElementById('current-city-text');
    if (cityText) cityText.innerText = cityName.toLowerCase();
}

function applyLang(lang) {
    const t = T[lang];
    if (!t) return;

    // Helper for safe element update
    const setText = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.innerText = text;
    };
    const setHtml = (id, html) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
    };

    // Marquee is now hardcoded in HTML, skip localization for it
    // setText('announcement', t.announcement);
    setText('hero-title', t.heroTitle);
    setText('hero-subtitle', t.heroSub);
    setText('section-title', t.sectionTitle);
    setText('loading-text', t.loading);
    setText('footer-about', t.footerAbout);
    setText('footer-privacy', t.footerPrivacy);
    setText('footer-support', t.footerSupport);
    setText('footer-size', t.footerSize);
    setText('footer-shipping', t.footerShipping);
    setText('footer-faq', t.footerFaq);
    setText('footer-contact', t.footerContact);
    setText('size-title', t.sizeTitle);
    setText('size-desc', t.sizeDesc);
    setText('th-size', t.thSize);
    setText('th-height', t.thHeight);
    setText('th-weight', t.thWeight);
    setText('about-title', t.aboutTitle);
    setText('about-p1', t.aboutP1);
    setText('about-p2', t.aboutP2);
    setText('about-values-title', t.aboutValuesTitle);
    setHtml('values-list', t.values.map(v => `<li>${v}</li>`).join(''));

    // City Modal
    setText('city-title', t.cityTitle);
    setText('city-note', t.cityNote);

    // Cart Modal
    setText('cart-title', t.cartTitle);
    setText('cart-total-text', t.total + ':');
    setText('btn-checkout', t.checkout);

    // Update city buttons
    const cityBtns = document.querySelectorAll('.city-btn');
    // City buttons are now handled by static HTML (no dynamic text needed)

    const copyright = document.querySelector('.copyright');
    if (copyright) copyright.innerText = t.copyright;

    setText('privacy-title', t.privacyTitle);
    setHtml('privacy-content', t.privacyContent);
    setText('shipping-title', t.shippingTitle);
    setHtml('shipping-content', t.shippingContent);
    setText('faq-title', t.faqTitle);
    setHtml('faq-content', t.faqContent);

    // Category filters translations
    setText('filter-all', t.filterAll);
    setText('filter-clothing', t.filterClothing);
    setText('filter-accessory', t.filterAccessory);

    if (Object.keys(productsData).length > 0) renderGrid();
}

// --- CATEGORY FILTER ---
window.filterCategory = function (category) {
    currentCategory = category;

    // Update active button
    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('filter-' + category).classList.add('active');

    renderGrid();
}

// --- STORE ---
function initStore() {
    window.db.ref('products').on('value', (snap) => {
        productsData = snap.val();
        const t = T[currentLang || 'kz'];
        if (!productsData) {
            document.getElementById('product-grid').innerHTML = `<p>${t.noItems}</p>`;
            return;
        }
        renderGrid();
    });
    window.db.ref('promocodes').on('value', (snap) => {
        promoCodes = snap.val() || {};

        // Auto-apply promo logic
        let promoCodeToApply = null;

        // 1. Check URL Params (Search)
        const params = new URLSearchParams(window.location.search);
        if (params.has('promo')) promoCodeToApply = params.get('promo');

        // 2. Check Hash Params (fallback)
        if (!promoCodeToApply && window.location.hash.includes('?')) {
            const hashParams = new URLSearchParams(window.location.hash.split('?')[1]);
            if (hashParams.has('promo')) promoCodeToApply = hashParams.get('promo');
        }

        // 3. Fallback to LocalStorage
        if (!promoCodeToApply) {
            promoCodeToApply = localStorage.getItem('alpharaon_promo');
        }

        if (promoCodeToApply && !activePromo) {
            applyPromo(promoCodeToApply);
        }
    });
}

function renderGrid() {
    const grid = document.getElementById('product-grid');
    const t = T[currentLang || 'kz'];
    grid.innerHTML = "";

    Object.entries(productsData).forEach(([key, p]) => {
        const isAccessory = p.type === 'accessory';

        // Filter by category
        if (currentCategory === 'clothing' && isAccessory) return;
        if (currentCategory === 'accessory' && !isAccessory) return;

        // Handle multiple images (backward compatible)
        const images = p.images || [p.image];
        const imgSrc = images[0].startsWith('http') ? images[0] : `images/${images[0]}`;

        // Calculate total stock
        let totalStock = 0;
        if (p.stock) {
            Object.values(p.stock).forEach(qty => totalStock += (qty || 0));
        }
        const isOutOfStock = totalStock === 0;
        const isLowStock = totalStock > 0 && totalStock <= 3;

        // Low stock / out of stock badges
        let badgeHtml = '';
        if (isOutOfStock) {
            badgeHtml = `<span class="card-badge sold-out">${t.outOfStock}</span>`;
        } else if (isLowStock) {
            badgeHtml = `<span class="card-badge low">${t.lowStock}</span>`;
        }

        // Price & Sale Logic
        let priceHtml = `<p class="price">${Number(p.price).toLocaleString()}‚Ç∏</p>`;
        let saleBadge = '';

        if (p.salePrice) {
            priceHtml = `
                <p class="price">
                    <span style="text-decoration: line-through; color: #999; font-size: 0.9em; margin-right: 6px;">${Number(p.price).toLocaleString()}‚Ç∏</span>
                    <span style="color: #d32f2f;">${Number(p.salePrice).toLocaleString()}‚Ç∏</span>
                </p>
            `;
            if (!isOutOfStock) {
                saleBadge = `<span class="card-badge" style="top: 10px; right: 10px; left: auto; background: #d32f2f; color: white;">SALE</span>`;
            }
        }

        const div = document.createElement('div');
        div.className = 'product-card';
        div.onclick = () => openProductDetail(key);
        div.innerHTML = `
            <div class="image-box">
                <img src="${imgSrc}" onerror="this.style.background='#f0f0f0'" loading="lazy">
                ${badgeHtml}
                ${saleBadge}
            </div>
            <div class="product-info">
                <h3>${p.name}</h3>
                ${priceHtml}
            </div>
        `;
        grid.appendChild(div);
    });
}

// Image gallery navigation
window.nextImage = function (box) {
    const images = JSON.parse(box.dataset.images);
    if (images.length <= 1) return;

    let idx = parseInt(box.dataset.idx) || 0;
    idx = (idx + 1) % images.length;
    box.dataset.idx = idx;

    const imgSrc = images[idx].startsWith('http') ? images[idx] : `images/${images[idx]}`;
    box.querySelector('img').src = imgSrc;

    // Update dots
    box.querySelectorAll('.gallery-dot').forEach((dot, i) => {
        dot.classList.toggle('active', i === idx);
    });
}

function renderSizeChips(key, stock) {
    if (!stock) return "<span style='color:#999'>‚Äî</span>";
    const sizes = ['S', 'M', 'L', 'XL'];
    return sizes.map(size => {
        const qty = stock[size] || 0;
        const disabled = qty <= 0 ? 'disabled' : '';
        const onclick = qty > 0 ? `selectSize('${key}', '${size}')` : '';
        return `<div class="size-chip ${disabled}" onclick="${onclick}">${size}</div>`;
    }).join('');
}

window.selectSize = function (key, size) {
    selectedSizes[key] = size;
    const container = document.getElementById(`sizes-${key}`);
    container.querySelectorAll('.size-chip').forEach(c => c.classList.remove('selected'));
    for (let c of container.children) {
        if (c.innerText === size) c.classList.add('selected');
    }
}

// --- PRODUCT DETAIL MODAL ---
let currentDetailKey = null;
let detailImageIdx = 0;

window.openProductDetail = function (key) {
    const p = productsData[key];
    if (!p) return;

    currentDetailKey = key;
    detailImageIdx = 0;
    const t = T[currentLang || 'kz'];

    // Images
    const images = p.images || [p.image];
    const imgSrc = images[0].startsWith('http') ? images[0] : `images/${images[0]}`;
    document.getElementById('product-main-img').src = imgSrc;

    // Gallery dots
    const dotsContainer = document.getElementById('product-dots');
    if (images.length > 1) {
        dotsContainer.innerHTML = images.map((_, i) =>
            `<span class="gallery-dot${i === 0 ? ' active' : ''}" onclick="detailGalleryTo(${i})"></span>`
        ).join('');
        dotsContainer.style.display = 'flex';
    } else {
        dotsContainer.style.display = 'none';
    }

    // Click on image to cycle
    document.getElementById('product-gallery').onclick = () => {
        if (images.length <= 1) return;
        detailImageIdx = (detailImageIdx + 1) % images.length;
        const src = images[detailImageIdx].startsWith('http') ? images[detailImageIdx] : `images/${images[detailImageIdx]}`;
        document.getElementById('product-main-img').src = src;
        dotsContainer.querySelectorAll('.gallery-dot').forEach((d, i) => d.classList.toggle('active', i === detailImageIdx));
    };

    // Info
    document.getElementById('product-badge').style.display = 'none'; // Can show NEW badge if needed
    document.getElementById('product-name').textContent = p.name;

    if (p.salePrice) {
        document.getElementById('product-price').innerHTML = `
            <span style="text-decoration: line-through; color: #999; margin-right: 10px;">${Number(p.price).toLocaleString()}‚Ç∏</span>
            <span style="color: #d32f2f;">${Number(p.salePrice).toLocaleString()}‚Ç∏</span>
        `;
    } else {
        document.getElementById('product-price').textContent = `${Number(p.price).toLocaleString()}‚Ç∏`;
    }

    // Size selector
    document.getElementById('size-label').textContent = t.sizeLabel;
    const sizesContainer = document.getElementById('product-sizes');
    const isAccessory = p.type === 'accessory';

    if (isAccessory) {
        selectedSizes[key] = 'ONE';
        sizesContainer.innerHTML = `<span style="color:#666">${t.oneSize}</span>`;
    } else {
        const sizes = ['S', 'M', 'L', 'XL'];
        sizesContainer.innerHTML = sizes.map(size => {
            const qty = (p.stock && p.stock[size]) || 0;
            const disabled = qty <= 0 ? 'disabled' : '';
            const selected = selectedSizes[key] === size ? 'selected' : '';
            return `<button class="size-btn ${disabled} ${selected}" onclick="selectDetailSize('${key}', '${size}')" ${qty <= 0 ? 'disabled' : ''}>${size}</button>`;
        }).join('');
    }

    // About Product
    document.getElementById('about-label').textContent = t.aboutProduct;
    let aboutText = '';
    if (p.specs) {
        const parts = [];
        if (p.specs.fabric) parts.push(`${t.specFabric}: ${p.specs.fabric}`);
        if (p.specs.gsm) parts.push(`${t.specGsm}: ${p.specs.gsm}`);
        if (p.specs.fit) parts.push(`${t.specFit}: ${p.specs.fit}`);
        if (p.specs.care) parts.push(`${t.specCare}: ${p.specs.care}`);
        aboutText = parts.join('<br>');
    } else {
        aboutText = currentLang === 'ru' ? '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞' : '–ê“õ–ø–∞—Ä–∞—Ç “õ–æ—Å—ã–ª–∞–¥—ã';
    }
    document.getElementById('about-text').innerHTML = aboutText;
    document.getElementById('about-content').style.display = 'none'; // Collapsed by default

    // Cart button
    document.getElementById('btn-detail-cart').textContent = t.toCart;

    // Check if out of stock
    let totalStock = 0;
    if (p.stock) Object.values(p.stock).forEach(qty => totalStock += (qty || 0));
    const cartBtn = document.getElementById('btn-detail-cart');
    if (totalStock === 0) {
        cartBtn.disabled = true;
        cartBtn.textContent = t.outOfStock;
        cartBtn.classList.add('btn-disabled');
    } else {
        cartBtn.disabled = false;
        cartBtn.classList.remove('btn-disabled');
    }

    document.getElementById('product-modal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

window.detailGalleryTo = function (idx) {
    const p = productsData[currentDetailKey];
    if (!p) return;
    const images = p.images || [p.image];
    detailImageIdx = idx;
    const src = images[idx].startsWith('http') ? images[idx] : `images/${images[idx]}`;
    document.getElementById('product-main-img').src = src;
    document.getElementById('product-dots').querySelectorAll('.gallery-dot').forEach((d, i) => d.classList.toggle('active', i === idx));
}

window.selectDetailSize = function (key, size) {
    selectedSizes[key] = size;
    document.querySelectorAll('#product-sizes .size-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.textContent === size);
    });
}

window.toggleAbout = function () {
    const content = document.getElementById('about-content');
    const arrow = document.querySelector('.about-arrow');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.textContent = '‚Üë';
    } else {
        content.style.display = 'none';
        arrow.textContent = '‚Üì';
    }
}

window.addToCartFromDetail = function () {
    if (!currentDetailKey) return;
    const t = T[currentLang || 'kz'];
    const p = productsData[currentDetailKey];
    const size = selectedSizes[currentDetailKey];

    if (!size && p.type !== 'accessory') {
        alert(t.selectSize);
        return;
    }

    cart.push({
        key: currentDetailKey,
        name: p.name,
        price: p.salePrice || p.price,
        size: size || 'ONE',
        image: p.image || (p.images && p.images[0]),
        type: p.type
    });

    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();

    // Visual feedback
    const btn = document.getElementById('btn-detail-cart');
    btn.textContent = '‚úì ' + t.addedToCart;
    setTimeout(() => {
        btn.textContent = t.toCart;
    }, 1500);
}

// --- CART LOGIC ---
window.addToCart = function (key) {
    const t = T[currentLang || 'kz'];
    const p = productsData[key];
    const size = selectedSizes[key];

    if (!size) { alert(t.selectSize); return; }

    cart.push({
        key: key,
        name: p.name,
        price: p.salePrice || p.price,
        size: size,
        image: p.image,
        type: p.type
    });

    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
    alert(t.addedToCart);
}

window.updateCartCount = function () {
    const badge = document.getElementById('cart-badge');
    badge.innerText = cart.length;
    badge.style.display = cart.length > 0 ? 'flex' : 'none';
}

window.openCart = function () {
    renderCart();
    document.getElementById('cart-modal').style.display = 'flex';
}

window.renderCart = function () {
    const container = document.getElementById('cart-items');
    const t = T[currentLang || 'kz'];

    if (cart.length === 0) {
        container.innerHTML = `<p style="text-align:center; padding: 20px; color: #666;">${t.emptyCart}</p>`;
        document.getElementById('cart-total-price').innerText = "0 ‚Ç∏";
        return;
    }

    let total = 0;
    container.innerHTML = cart.map((item, index) => {
        total += Number(item.price);
        const imgSrc = item.image.startsWith('http') ? item.image : `images/${item.image}`;
        return `
            <div class="cart-item">
                <div style="display:flex; align-items:center;">
                    <img src="${imgSrc}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 12px;">
                    <div class="cart-item-info">
                        <h4>${item.name}</h4>
                        <p>${item.size !== 'ONE' ? item.size : t.oneSize} | ${Number(item.price).toLocaleString()} ‚Ç∏</p>
                    </div>
                </div>
                <button class="btn-remove" onclick="removeFromCart(${index})">&times;</button>
            </div>
        `;
    }).join('');

    if (activePromo) {
        let discountAmount = 0;
        if (activePromo.type === 'percent') {
            discountAmount = total * (activePromo.value / 100);
        } else {
            discountAmount = activePromo.value;
        }
        const finalTotal = Math.max(0, total - discountAmount);

        document.getElementById('cart-total-price').innerHTML = `
            <span style="text-decoration: line-through; color: #999; font-size: 14px;">${total.toLocaleString()} ‚Ç∏</span>
            <br>
            <span style="color: #10b981;">-${discountAmount.toLocaleString()} ‚Ç∏</span>
            <br>
            ${finalTotal.toLocaleString()} ‚Ç∏
        `;
    } else {
        document.getElementById('cart-total-price').innerText = `${total.toLocaleString()} ‚Ç∏`;
    }

    // Update promo input placeholder
    const input = document.getElementById('cart-promo-input');
    if (input) {
        input.placeholder = t.promoPlaceholder;
        if (activePromo) {
            input.value = activePromo.code;
            input.disabled = true;
            input.style.borderColor = "#10b981";
        }
    }
}

window.applyPromo = function (codeArg) {
    const input = document.getElementById('cart-promo-input');
    const code = (codeArg || input.value).trim().toUpperCase();
    const t = T[currentLang || 'kz'];

    if (!code) return;

    // Find promo (Case insensitive check)
    const promoKey = Object.keys(promoCodes).find(k =>
        String(promoCodes[k].code).toUpperCase() === code
    );

    if (promoKey) {
        const p = promoCodes[promoKey];
        if (p.limit && (p.used || 0) >= p.limit) {
            alert("This promo code has reached its usage limit!");
            activePromo = null;
            localStorage.removeItem('alpharaon_promo');
            if (input) input.value = "";
            return;
        }
        activePromo = p;
        // Persist promo
        localStorage.setItem('alpharaon_promo', p.code);

        renderCart();
        // Only alert if manually applied (input exists)
        if (!codeArg) {
            alert(t.promoApplied + "!");
        } else {
            // If from URL, just show in console or silent success
            console.log("Promo applied from URL:", p.code);
        }

        if (input) {
            input.value = activePromo.code;
            input.disabled = true;
            input.style.borderColor = "#10b981";
        }
    } else {
        if (!codeArg) {
            alert(t.invalidPromo);
            input.value = "";
        }
    }
}

window.removeFromCart = function (index) {
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
    renderCart();
}

// Open checkout with city confirmation
window.checkoutCart = function () {
    if (cart.length === 0) return;
    pendingOrder = [...cart]; // Copy cart items
    isCartCheckout = true;
    startCheckout();
}

let pendingOrder = null;
let isCartCheckout = false;

window.buyItem = function (key) {
    const p = productsData[key];
    const size = selectedSizes[key];
    const t = T[currentLang || 'kz'];

    if (!size) { alert(t.selectSize); return; }

    // pendingOrder is array even for single item
    pendingOrder = [{
        key: key,
        name: p.name,
        price: p.salePrice || p.price,
        size: size,
        type: p.type
    }];
    isCartCheckout = false;
    startCheckout();
}

window.deprecated_selectCity = function (city) {
    console.warn('Deprecated function called');
}

// Proceed with order (send to WhatsApp)
window.proceedWithOrder = function (city) {
    if (!pendingOrder || pendingOrder.length === 0) return;

    // Calculate total price of items (excluding shipping as per request)
    const itemsTotal = pendingOrder.reduce((sum, item) => sum + Number(item.price), 0);

    // Promo logic
    let finalTotal = itemsTotal;
    let promoText = "";

    if (activePromo) {
        if (activePromo.type === 'percent') {
            const discount = Math.floor(itemsTotal * (activePromo.value / 100));
            finalTotal = itemsTotal - discount;
            promoText = `\nüéÅ Promo: ${activePromo.code} (-${activePromo.value}%)`;
        } else if (activePromo.type === 'fixed') {
            finalTotal = Math.max(0, itemsTotal - activePromo.value);
            promoText = `\nüéÅ Promo: ${activePromo.code} (-${activePromo.value}‚Ç∏)`;
        }
    }

    // Determine Language for Message
    const isRu = (currentLang === 'ru');

    // Build Message
    let msg = isRu ? "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –•–æ—á—É –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑:\n\n" : "–°”ô–ª–µ–º–µ—Ç—Å—ñ–∑ –±–µ! –¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä–≥—ñ–º –∫–µ–ª–µ–¥—ñ:\n\n";

    pendingOrder.forEach(item => {
        msg += `‚ñ™Ô∏è ${item.name} (${item.size}) - ${item.price}‚Ç∏\n`;
    });

    const formatPriceMsg = (price) => price.toLocaleString('ru-RU') + ' ‚Ç∏';

    msg += `\nüí∞ –°—É–º–º–∞: ${formatPriceMsg(itemsTotal)}`;
    if (promoText) msg += promoText;
    msg += `\nüè∑ –ò—Ç–æ–≥–æ: ${formatPriceMsg(finalTotal)}`;

    // City name mapping
    const cityNamesMsg = {
        'Astana': '–ê—Å—Ç–∞–Ω–∞',
        'Almaty': '–ê–ª–º–∞—Ç—ã',
        'Shymkent': '–®—ã–º–∫–µ–Ω—Ç',
        'Other': '–î—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥'
    };
    const prettyCity = cityNamesMsg[city] || city;

    msg += isRu ? `\nüìç –ì–æ—Ä–æ–¥: ${prettyCity}` : `\nüìç “ö–∞–ª–∞: ${prettyCity}`;
    msg += isRu ? `\nüì¶ –î–æ—Å—Ç–∞–≤–∫–∞: —É—Ç–æ—á–Ω–∏—Ç—å —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞` : `\nüì¶ –ñ–µ—Ç–∫—ñ–∑—É: –º–µ–Ω–µ–¥–∂–µ—Ä–¥–µ–Ω –Ω–∞“õ—Ç—ã–ª–∞—É`;

    // Save order to Firebase
    if (window.db) {
        pendingOrder.forEach(item => {
            window.db.ref('orders').push({
                product: item.name,
                size: item.size,
                city: city,
                price: item.price,
                total: finalTotal,
                promo: activePromo ? activePromo.code : null,
                status: 'pending',
                timestamp: new Date().toISOString()
            });
        });
    }

    window.open(`https://wa.me/77055020133?text=${encodeURIComponent(msg)}`, '_blank');

    // Increment promo usage
    if (activePromo) {
        const promoKey = Object.keys(promoCodes).find(k => promoCodes[k].code === activePromo.code);
        if (promoKey) {
            window.db.ref(`promocodes/${promoKey}/used`).transaction(current => (current || 0) + 1);
        }
    }

    // Clear cart if this was a cart checkout
    if (isCartCheckout) {
        cart = [];
        updateCartCount();
        localStorage.setItem('cart', '[]');
        renderCart();
    }

    pendingOrder = null;
}

// --- MODALS ---
window.openSizeGuide = function (e) { if (e) e.preventDefault(); document.getElementById('size-modal').style.display = 'flex'; return false; }
window.openAbout = function (e) { if (e) e.preventDefault(); document.getElementById('about-modal').style.display = 'flex'; return false; }
window.openPrivacy = function (e) { if (e) e.preventDefault(); document.getElementById('privacy-modal').style.display = 'flex'; return false; }
window.openShipping = function (e) { if (e) e.preventDefault(); document.getElementById('shipping-modal').style.display = 'flex'; return false; }
window.openFaq = function (e) { if (e) e.preventDefault(); document.getElementById('faq-modal').style.display = 'flex'; return false; }
window.closeModal = function (id) {
    document.getElementById(id).style.display = 'none';
    document.body.style.overflow = '';
}
window.onclick = function (e) {
    ['size-modal', 'about-modal', 'lang-modal', 'privacy-modal', 'shipping-modal', 'faq-modal', 'product-modal', 'cart-modal'].forEach(id => {
        if (e.target === document.getElementById(id)) {
            document.getElementById(id).style.display = 'none';
            document.body.style.overflow = '';
        }
    });
}
