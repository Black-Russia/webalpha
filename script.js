// --- TRANSLATIONS ---
const T = {
    kz: {
        announcement: "ТЕГІН ЖЕТКІЗУ 15 000 ₸ АСТАМ ТАПСЫРЫСТАРҒА",
        heroTitle: "Жаңа Коллекция 2026",
        heroSub: "Сапалы киім. ALPHARAON таңдауы.",
        sectionTitle: "Барлық тауарлар",
        loading: "Жүктелуде...",
        noItems: "Тауарлар жоқ",
        selectSize: "Өлшемді таңдаңыз!",
        buyNow: "Сатып алу",
        sizeGuide: "Өлшем кестесі",
        oneSize: "Бір өлшем",
        footerAbout: "Біз туралы",
        footerPrivacy: "Құпиялылық саясаты",
        footerSupport: "Қолдау",
        footerSize: "Өлшем кестесі",
        footerShipping: "Жеткізу",
        footerFaq: "FAQ",
        footerContact: "Байланыс",
        sizeTitle: "Өлшем кестесі",
        sizeDesc: "Oversize пішімі. Еркін киім үшін бір өлшем үлкен алыңыз.",
        thHeight: "Бой (см)",
        thWeight: "Салмақ (кг)",
        aboutTitle: "Біз туралы",
        aboutP1: "ALPHARAON 2026 жылы құрылды. Біздің мақсатымыз — ең сапалы streetwear тауарларды таңдап, сізге ұсыну.",
        aboutP2: "Біз трендтерді соқыр қуамыз емес. Біз әрқашан өзекті, сапалы киім таңдаймыз. Біз өз ісімізді сүйеміз.",
        aboutValuesTitle: "Біздің құндылықтар",
        values: ["• Адалдық", "• Сапа", "• Даму", "• Сенім"],
        copyright: "© 2026 ALPHARAON. Барлық құқықтар қорғалған.",
        privacyTitle: "Құпиялылық саясаты",
        privacyContent: `<p style="margin-bottom: 16px;">Біз сіздің жеке деректеріңізді қорғаймыз:</p>
            <ul style="margin-left: 20px; margin-bottom: 16px;">
                <li>Аты-жөніңіз тек тапсырыс үшін қолданылады</li>
                <li>Телефон нөміріңіз үшінші тарапқа берілмейді</li>
                <li>Төлем деректері сақталмайды</li>
            </ul>
            <p>Сұрақтар болса: +7 705 502 01 33</p>`,
        shippingTitle: "Жеткізу",
        shippingContent: `<p style="margin-bottom: 12px;"><strong>Астана, Алматы:</strong> 1-3 жұмыс күні</p>
            <p style="margin-bottom: 12px;"><strong>Басқа қалалар:</strong> 3-7 жұмыс күні</p>
            <p style="margin-bottom: 16px;"><strong>Бағасы:</strong> 15 000₸ астам тапсырыстарға — ТЕГІН</p>
            <p>Жеткізу Kaspi арқылы жүзеге асырылады.</p>`,
        faqTitle: "Жиі қойылатын сұрақтар",
        faqContent: `<p style="font-weight: 600; margin-bottom: 8px;">Қалай төлеймін?</p>
            <p style="margin-bottom: 16px; color: #666;">Kaspi аударым немесе Kaspi QR арқылы.</p>
            <p style="font-weight: 600; margin-bottom: 8px;">Қайтару бар ма?</p>
            <p style="margin-bottom: 16px; color: #666;">Иә, 14 күн ішінде қайтаруға болады (тег алынбаса).</p>
            <p style="font-weight: 600; margin-bottom: 8px;">Өлшем дұрыс келмесе?</p>
            <p style="color: #666;">Алмастыру тегін. WhatsApp-қа жазыңыз.</p>`,
        reviews: "пікір"
    },
    ru: {
        announcement: "БЕСПЛАТНАЯ ДОСТАВКА ОТ 15 000 ₸",
        heroTitle: "Новая Коллекция 2026",
        heroSub: "Качественная одежда. Выбор ALPHARAON.",
        sectionTitle: "Все товары",
        loading: "Загрузка...",
        noItems: "Товаров нет",
        selectSize: "Выберите размер!",
        buyNow: "Купить",
        sizeGuide: "Таблица размеров",
        oneSize: "Один размер",
        footerAbout: "О нас",
        footerPrivacy: "Құпиялылық саясаты",
        footerSupport: "Поддержка",
        footerSize: "Таблица размеров",
        footerShipping: "Доставка",
        footerFaq: "FAQ",
        footerContact: "Контакты",
        sizeTitle: "Таблица размеров",
        sizeDesc: "Oversize крой. Для свободной посадки берите на размер больше.",
        thHeight: "Рост (см)",
        thWeight: "Вес (кг)",
        aboutTitle: "О нас",
        aboutP1: "ALPHARAON был основан в 2026 году. Наша цель — отбирать лучшие streetwear товары и предлагать их вам.",
        aboutP2: "Мы не следуем слепо за трендами. Мы выбираем актуальную, качественную одежду. Мы любим своё дело.",
        aboutValuesTitle: "Наши ценности",
        values: ["• Честность", "• Качество", "• Развитие", "• Доверие"],
        copyright: "© 2026 ALPHARAON. Все права защищены.",
        privacyTitle: "Құпиялылық саясаты",
        privacyContent: `<p style="margin-bottom: 16px;">Мы защищаем ваши персональные данные:</p>
            <ul style="margin-left: 20px; margin-bottom: 16px;">
                <li>Ваше имя используется только для заказа</li>
                <li>Телефон не передаётся третьим лицам</li>
                <li>Платёжные данные не сохраняются</li>
            </ul>
            <p>Вопросы: +7 705 502 01 33</p>`,
        shippingTitle: "Доставка",
        shippingContent: `<p style="margin-bottom: 12px;"><strong>Астана, Алматы:</strong> 1-3 рабочих дня</p>
            <p style="margin-bottom: 12px;"><strong>Другие города:</strong> 3-7 рабочих дней</p>
            <p style="margin-bottom: 16px;"><strong>Стоимость:</strong> от 15 000₸ — БЕСПЛАТНО</p>
            <p>Доставка осуществляется через Kaspi.</p>`,
        faqTitle: "Часто задаваемые вопросы",
        faqContent: `<p style="font-weight: 600; margin-bottom: 8px;">Как оплатить?</p>
            <p style="margin-bottom: 16px; color: #666;">Kaspi перевод или Kaspi QR.</p>
            <p style="font-weight: 600; margin-bottom: 8px;">Есть возврат?</p>
            <p style="margin-bottom: 16px; color: #666;">Да, в течение 14 дней (если бирка не снята).</p>
            <p style="font-weight: 600; margin-bottom: 8px;">Если размер не подошёл?</p>
            <p style="color: #666;">Обмен бесплатный. Напишите в WhatsApp.</p>`,
        reviews: "отзывов"
    }
};

let currentLang = localStorage.getItem('alpharaon_lang') || null;
let productsData = {};
let selectedSizes = {};

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    if (currentLang) {
        document.getElementById('lang-modal').style.display = 'none';
        applyLang(currentLang);
    }
    setTimeout(() => { if (window.db) initStore(); }, 500);
});

// --- LANGUAGE ---
window.setLang = function (lang) {
    currentLang = lang;
    localStorage.setItem('alpharaon_lang', lang);
    document.getElementById('lang-modal').style.display = 'none';
    applyLang(lang);
}

window.openLangModal = function () {
    document.getElementById('lang-modal').style.display = 'flex';
}

function applyLang(lang) {
    const t = T[lang];
    document.getElementById('announcement').innerText = t.announcement;
    document.getElementById('hero-title').innerText = t.heroTitle;
    document.getElementById('hero-subtitle').innerText = t.heroSub;
    document.getElementById('section-title').innerText = t.sectionTitle;
    document.getElementById('loading-text').innerText = t.loading;
    document.getElementById('footer-about').innerText = t.footerAbout;
    document.getElementById('footer-privacy').innerText = t.footerPrivacy;
    document.getElementById('footer-support').innerText = t.footerSupport;
    document.getElementById('footer-size').innerText = t.footerSize;
    document.getElementById('footer-shipping').innerText = t.footerShipping;
    document.getElementById('footer-faq').innerText = t.footerFaq;
    document.getElementById('footer-contact').innerText = t.footerContact;
    document.getElementById('size-title').innerText = t.sizeTitle;
    document.getElementById('size-desc').innerText = t.sizeDesc;
    document.getElementById('th-height').innerText = t.thHeight;
    document.getElementById('th-weight').innerText = t.thWeight;
    document.getElementById('about-title').innerText = t.aboutTitle;
    document.getElementById('about-p1').innerText = t.aboutP1;
    document.getElementById('about-p2').innerText = t.aboutP2;
    document.getElementById('about-values-title').innerText = t.aboutValuesTitle;
    document.getElementById('values-list').innerHTML = t.values.map(v => `<li>${v}</li>`).join('');
    document.querySelector('.copyright').innerText = t.copyright;
    document.getElementById('privacy-title').innerText = t.privacyTitle;
    document.getElementById('privacy-content').innerHTML = t.privacyContent;
    document.getElementById('shipping-title').innerText = t.shippingTitle;
    document.getElementById('shipping-content').innerHTML = t.shippingContent;
    document.getElementById('faq-title').innerText = t.faqTitle;
    document.getElementById('faq-content').innerHTML = t.faqContent;

    if (Object.keys(productsData).length > 0) renderGrid();
}

// --- STORE ---
function initStore() {
    window.db.ref('products').on('value', (snap) => {
        productsData = snap.val();
        const t = T[currentLang || 'kz'];
        if (!productsData) {
            document.getElementById('product-grid').innerHTML = `<p>${t.noItems}</p>`;
            return;
        }
        renderGrid();
    });
}

function renderGrid() {
    const grid = document.getElementById('product-grid');
    const t = T[currentLang || 'kz'];
    grid.innerHTML = "";

    Object.entries(productsData).forEach(([key, p]) => {
        const imgSrc = p.image.startsWith('http') ? p.image : `images/${p.image}`;
        const isAccessory = p.type === 'accessory';

        // Deterministic review count based on product ID (1-10, same for all users)
        const hash = key.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        const reviewCount = (hash % 10) + 1; // Always 1 to 10

        let sizeHtml = '';
        if (isAccessory) {
            // No size selection needed, auto-select ONE
            selectedSizes[key] = 'ONE';
            const qty = (p.stock && p.stock.ONE) || 0;
            sizeHtml = qty > 0
                ? `<p style="color:#666; font-size:12px; margin-bottom:12px;">${t.oneSize}</p>`
                : `<p style="color:#999; font-size:12px; margin-bottom:12px;">—</p>`;
        } else {
            sizeHtml = `
                <button class="btn-text" onclick="openSizeGuide()">${t.sizeGuide}</button>
                <div class="size-selector" id="sizes-${key}">${renderSizeChips(key, p.stock)}</div>
            `;
        }

        const div = document.createElement('div');
        div.className = 'product-card';
        div.innerHTML = `
            <div class="image-box">
                <img src="${imgSrc}" onerror="this.style.background='#f0f0f0'">
            </div>
            <div class="product-info">
                <h3>${p.name}</h3>
                <div class="review-line">
                    <span class="stars">★★★★★</span>
                    <span class="review-count">${reviewCount} ${t.reviews}</span>
                </div>
                <p class="price">${Number(p.price).toLocaleString()} ₸</p>
                ${sizeHtml}
                <button class="btn-buy" onclick="buyItem('${key}')">${t.buyNow}</button>
            </div>
        `;
        grid.appendChild(div);
    });
}

function renderSizeChips(key, stock) {
    if (!stock) return "<span style='color:#999'>—</span>";
    const sizes = ['S', 'M', 'L', 'XL'];
    return sizes.map(size => {
        const qty = stock[size] || 0;
        const disabled = qty <= 0 ? 'disabled' : '';
        const onclick = qty > 0 ? `selectSize('${key}', '${size}')` : '';
        return `<div class="size-chip ${disabled}" onclick="${onclick}">${size}</div>`;
    }).join('');
}

window.selectSize = function (key, size) {
    selectedSizes[key] = size;
    const container = document.getElementById(`sizes-${key}`);
    container.querySelectorAll('.size-chip').forEach(c => c.classList.remove('selected'));
    for (let c of container.children) {
        if (c.innerText === size) c.classList.add('selected');
    }
}

window.buyItem = function (key) {
    const p = productsData[key];
    const size = selectedSizes[key];
    const t = T[currentLang || 'kz'];

    if (!size) { alert(t.selectSize); return; }

    window.db.ref('orders').push({
        item: p.name,
        productId: key,
        size: size,
        status: 'pending',
        timestamp: new Date().toISOString()
    });

    const msg = `Сәлем! Тапсырыс: ${p.name}${size !== 'ONE' ? ` (${size})` : ''}`;
    window.open(`https://wa.me/77055020133?text=${encodeURIComponent(msg)}`, '_blank');
}

// --- MODALS ---
window.openSizeGuide = function () { document.getElementById('size-modal').style.display = 'flex'; }
window.openAbout = function () { document.getElementById('about-modal').style.display = 'flex'; }
window.openPrivacy = function () { document.getElementById('privacy-modal').style.display = 'flex'; }
window.openShipping = function () { document.getElementById('shipping-modal').style.display = 'flex'; }
window.openFaq = function () { document.getElementById('faq-modal').style.display = 'flex'; }
window.closeModal = function (id) { document.getElementById(id).style.display = 'none'; }
window.onclick = function (e) {
    ['size-modal', 'about-modal', 'lang-modal', 'privacy-modal', 'shipping-modal', 'faq-modal'].forEach(id => {
        if (e.target === document.getElementById(id)) document.getElementById(id).style.display = 'none';
    });
}
