// --- TRANSLATIONS ---
const T = {
    kz: {
        announcement: "ТЕГІН ЖЕТКІЗУ 15 000 ₸ АСТАМ ТАПСЫРЫСТАРҒА",
        heroTitle: "Жаңа Коллекция 2026",
        heroSub: "Сапалы киім. ALPHARAON таңдауы.",
        sectionTitle: "Барлық тауарлар",
        loading: "Жүктелуде...",
        noItems: "Тауарлар жоқ",
        selectSize: "Өлшемді таңдаңыз!",
        buyNow: "Сатып алу",
        outOfStock: "Сатылымда жоқ",
        lowStock: "Аз қалды",
        cityTitle: "Қаланы таңдаңыз",
        cityNote: "*15 000₸ астам - Астана/Алматы тегін",
        otherCity: "Басқа қала",
        cartTitle: "Себет",
        addToCart: "Себетке салу",
        checkout: "Тапсырыс беру",
        total: "Барлығы",
        emptyCart: "Себет бос",
        addedToCart: "Себетке қосылды!",
        cities: {
            Astana: "Астана",
            Almaty: "Алматы",
            Karaganda: "Қарағанды",
            Shymkent: "Шымкент",
            Aktobe: "Ақтөбе",
            Other: "Басқа қала"
        },
        waGreeting: "Сәлем! Тапсырыс бергім келеді:",
        waSize: "Өлшем",
        waCity: "Қала",
        waDelivery: "Жеткізу",
        waPrice: "Бағасы",
        oneSize: "Бір өлшем",
        footerAbout: "Біз туралы",
        footerPrivacy: "Құпиялылық саясаты",
        footerSupport: "Қолдау",
        footerSize: "Өлшем кестесі",
        footerShipping: "Жеткізу",
        footerFaq: "FAQ",
        footerContact: "Байланыс",
        sizeTitle: "Өлшем кестесі",
        sizeDesc: "Oversize пішімі. Еркін киім үшін бір өлшем үлкен алыңыз.",
        thHeight: "Бой (см)",
        thWeight: "Салмақ (кг)",
        thSize: "Өлшем",
        aboutTitle: "Біз туралы",
        aboutP1: "ALPHARAON 2026 жылы құрылды. Біздің мақсатымыз — ең сапалы streetwear тауарларды таңдап, сізге ұсыну.",
        aboutP2: "Біз трендтерді соқыр қуамыз емес. Біз әрқашан өзекті, сапалы киім таңдаймыз. Біз өз ісімізді сүйеміз.",
        aboutValuesTitle: "Біздің құндылықтар",
        values: ["• Адалдық", "• Сапа", "• Даму", "• Сенім"],
        copyright: "© 2026 ALPHARAON. Барлық құқықтар қорғалған.",
        privacyTitle: "Құпиялылық саясаты",
        privacyContent: `<p style="margin-bottom: 16px;">Біз сіздің жеке деректеріңізді қорғаймыз:</p>
            <ul style="margin-left: 20px; margin-bottom: 16px;">
                <li>Аты-жөніңіз тек тапсырыс үшін қолданылады</li>
                <li>Телефон нөміріңіз үшінші тарапқа берілмейді</li>
                <li>Төлем деректері сақталмайды</li>
            </ul>
            <p>Сұрақтар болса: +7 705 502 01 33</p>`,
        shippingTitle: "Жеткізу",
        shippingContent: `<p style="margin-bottom: 12px;"><strong>Астана, Алматы:</strong> 1-3 жұмыс күні — <strong>1 500₸</strong></p>
            <p style="margin-bottom: 12px;"><strong>Қарағанды, Шымкент, Ақтөбе:</strong> 3-5 жұмыс күні — <strong>2 000₸</strong></p>
            <p style="margin-bottom: 16px;"><strong>Басқа қалалар:</strong> Пошта арқылы 5-10 күн — <strong>2 500-3 000₸</strong></p>
            <p style="margin-bottom: 12px; color: #666;">15 000₸ астам тапсырыстарға Астана/Алматы жеткізу ТЕГІН!</p>
            <p>Сұрақтар бойынша: <a href="https://wa.me/77055020133" style="color:#25D366; font-weight:600;">WhatsApp</a></p>`,
        faqTitle: "Жиі қойылатын сұрақтар",
        faqContent: `<p style="font-weight: 600; margin-bottom: 8px;">Қалай төлеймін?</p>
            <p style="margin-bottom: 16px; color: #666;">Kaspi аударым немесе Kaspi QR арқылы.</p>
            <p style="font-weight: 600; margin-bottom: 8px;">Қайтару бар ма?</p>
            <p style="margin-bottom: 16px; color: #666;">Иә, 14 күн ішінде қайтаруға болады (тег алынбаса).</p>
            <p style="font-weight: 600; margin-bottom: 8px;">Өлшем дұрыс келмесе?</p>
            <p style="color: #666;">Алмастыру тегін. WhatsApp-қа жазыңыз.</p>`,
        reviews: "пікір",
        filterAll: "Барлығы",
        filterClothing: "Киім",
        filterAccessory: "Аксессуар"
    },
    ru: {
        announcement: "БЕСПЛАТНАЯ ДОСТАВКА ОТ 15 000 ₸",
        heroTitle: "Новая Коллекция 2026",
        heroSub: "Качественная одежда. Выбор ALPHARAON.",
        sectionTitle: "Все товары",
        loading: "Загрузка...",
        noItems: "Товаров нет",
        selectSize: "Выберите размер!",
        buyNow: "Купить",
        outOfStock: "Нет в наличии",
        lowStock: "Мало",
        cityTitle: "Выберите город",
        cityNote: "*От 15 000₸ - Астана/Алматы бесплатно",
        otherCity: "Другой город",
        cartTitle: "Корзина",
        addToCart: "В корзину",
        checkout: "Оформить",
        total: "Итого",
        emptyCart: "Корзина пуста",
        addedToCart: "Добавлено в корзину!",
        cities: {
            Astana: "Астана",
            Almaty: "Алматы",
            Karaganda: "Караганда",
            Shymkent: "Шымкент",
            Aktobe: "Актобе",
            Other: "Другой город"
        },
        waGreeting: "Привет! Хочу заказать:",
        waSize: "Размер",
        waCity: "Город",
        waDelivery: "Доставка",
        waPrice: "Цена",
        oneSize: "Один размер",
        footerAbout: "О нас",
        footerPrivacy: "Политика конфиденциальности",
        footerSupport: "Поддержка",
        footerSize: "Таблица размеров",
        footerShipping: "Доставка",
        footerFaq: "FAQ",
        footerContact: "Контакты",
        sizeTitle: "Таблица размеров",
        sizeDesc: "Oversize крой. Для свободной посадки берите на размер больше.",
        thHeight: "Рост (см)",
        thWeight: "Вес (кг)",
        thSize: "Размер",
        aboutTitle: "О нас",
        aboutP1: "ALPHARAON был основан в 2026 году. Наша цель — отбирать лучшие streetwear товары и предлагать их вам.",
        aboutP2: "Мы не следуем слепо за трендами. Мы выбираем актуальную, качественную одежду. Мы любим своё дело.",
        aboutValuesTitle: "Наши ценности",
        values: ["• Честность", "• Качество", "• Развитие", "• Доверие"],
        copyright: "© 2026 ALPHARAON. Все права защищены.",
        privacyTitle: "Политика конфиденциальности",
        privacyContent: `<p style="margin-bottom: 16px;">Мы защищаем ваши персональные данные:</p>
            <ul style="margin-left: 20px; margin-bottom: 16px;">
                <li>Ваше имя используется только для заказа</li>
                <li>Телефон не передаётся третьим лицам</li>
                <li>Платёжные данные не сохраняются</li>
            </ul>
            <p>Вопросы: +7 705 502 01 33</p>`,
        shippingTitle: "Доставка",
        shippingContent: `<p style="margin-bottom: 12px;"><strong>Астана, Алматы:</strong> 1-3 рабочих дня — <strong>1 500₸</strong></p>
            <p style="margin-bottom: 12px;"><strong>Караганда, Шымкент, Актобе:</strong> 3-5 рабочих дней — <strong>2 000₸</strong></p>
            <p style="margin-bottom: 16px;"><strong>Другие города:</strong> Почтой 5-10 дней — <strong>2 500-3 000₸</strong></p>
            <p style="margin-bottom: 12px; color: #666;">При заказе от 15 000₸ доставка по Астане/Алматы БЕСПЛАТНО!</p>
            <p>Вопросы: <a href="https://wa.me/77055020133" style="color:#25D366; font-weight:600;">WhatsApp</a></p>`,
        faqTitle: "Часто задаваемые вопросы",
        faqContent: `<p style="font-weight: 600; margin-bottom: 8px;">Как оплатить?</p>
            <p style="margin-bottom: 16px; color: #666;">Kaspi перевод или Kaspi QR.</p>
            <p style="font-weight: 600; margin-bottom: 8px;">Есть возврат?</p>
            <p style="margin-bottom: 16px; color: #666;">Да, в течение 14 дней (если бирка не снята).</p>
            <p style="font-weight: 600; margin-bottom: 8px;">Если размер не подошёл?</p>
            <p style="color: #666;">Обмен бесплатный. Напишите в WhatsApp.</p>`,
        reviews: "отзывов",
        filterAll: "Все",
        filterClothing: "Одежда",
        filterAccessory: "Аксессуары"
    }
};

let currentLang = localStorage.getItem('alpharaon_lang') || null;
let productsData = {};
let selectedSizes = {};
let currentCategory = 'all';
let cart = JSON.parse(localStorage.getItem('cart') || '[]');

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    if (currentLang) {
        document.getElementById('lang-modal').style.display = 'none';
        applyLang(currentLang);
    }
    updateCartCount();
    setTimeout(() => { if (window.db) initStore(); }, 500);
});

// --- LANGUAGE ---
window.setLang = function (lang) {
    currentLang = lang;
    localStorage.setItem('alpharaon_lang', lang);
    document.getElementById('lang-modal').style.display = 'none';
    applyLang(lang);
    // Force re-render products with new language
    if (Object.keys(productsData).length > 0) {
        renderGrid();
    }
}

window.openLangModal = function () {
    document.getElementById('lang-modal').style.display = 'flex';
}

function applyLang(lang) {
    const t = T[lang];
    if (!t) return;

    // Helper for safe element update
    const setText = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.innerText = text;
    };
    const setHtml = (id, html) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
    };

    setText('announcement', t.announcement);
    setText('hero-title', t.heroTitle);
    setText('hero-subtitle', t.heroSub);
    setText('section-title', t.sectionTitle);
    setText('loading-text', t.loading);
    setText('footer-about', t.footerAbout);
    setText('footer-privacy', t.footerPrivacy);
    setText('footer-support', t.footerSupport);
    setText('footer-size', t.footerSize);
    setText('footer-shipping', t.footerShipping);
    setText('footer-faq', t.footerFaq);
    setText('footer-contact', t.footerContact);
    setText('size-title', t.sizeTitle);
    setText('size-desc', t.sizeDesc);
    setText('th-size', t.thSize);
    setText('th-height', t.thHeight);
    setText('th-weight', t.thWeight);
    setText('about-title', t.aboutTitle);
    setText('about-p1', t.aboutP1);
    setText('about-p2', t.aboutP2);
    setText('about-values-title', t.aboutValuesTitle);
    setHtml('values-list', t.values.map(v => `<li>${v}</li>`).join(''));

    // City Modal
    setText('city-title', t.cityTitle);
    setText('city-note', t.cityNote);

    // Cart Modal
    setText('cart-title', t.cartTitle);
    setText('cart-total-text', t.total + ':');
    setText('btn-checkout', t.checkout);

    // Update city buttons
    const cityBtns = document.querySelectorAll('.city-btn');
    if (cityBtns.length > 0) {
        cityBtns[0].innerText = `${t.cities.Astana} (1 500₸)`;
        cityBtns[1].innerText = `${t.cities.Almaty} (1 500₸)`;
        cityBtns[2].innerText = `${t.cities.Karaganda} (2 000₸)`;
        cityBtns[3].innerText = `${t.cities.Shymkent} (2 000₸)`;
        cityBtns[4].innerText = `${t.cities.Aktobe} (2 000₸)`;
        cityBtns[5].innerText = `${t.cities.Other} (3 000₸)`;
    }

    const copyright = document.querySelector('.copyright');
    if (copyright) copyright.innerText = t.copyright;

    setText('privacy-title', t.privacyTitle);
    setHtml('privacy-content', t.privacyContent);
    setText('shipping-title', t.shippingTitle);
    setHtml('shipping-content', t.shippingContent);
    setText('faq-title', t.faqTitle);
    setHtml('faq-content', t.faqContent);

    // Category filters translations
    setText('filter-all', t.filterAll);
    setText('filter-clothing', t.filterClothing);
    setText('filter-accessory', t.filterAccessory);

    if (Object.keys(productsData).length > 0) renderGrid();
}

// --- CATEGORY FILTER ---
window.filterCategory = function (category) {
    currentCategory = category;

    // Update active button
    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('filter-' + category).classList.add('active');

    renderGrid();
}

// --- STORE ---
function initStore() {
    window.db.ref('products').on('value', (snap) => {
        productsData = snap.val();
        const t = T[currentLang || 'kz'];
        if (!productsData) {
            document.getElementById('product-grid').innerHTML = `<p>${t.noItems}</p>`;
            return;
        }
        renderGrid();
    });
}

function renderGrid() {
    const grid = document.getElementById('product-grid');
    const t = T[currentLang || 'kz'];
    grid.innerHTML = "";

    Object.entries(productsData).forEach(([key, p]) => {
        const isAccessory = p.type === 'accessory';

        // Filter by category
        if (currentCategory === 'clothing' && isAccessory) return;
        if (currentCategory === 'accessory' && !isAccessory) return;

        const imgSrc = p.image.startsWith('http') ? p.image : `images/${p.image}`;

        // Calculate total stock
        let totalStock = 0;
        if (p.stock) {
            Object.values(p.stock).forEach(qty => totalStock += (qty || 0));
        }
        const isOutOfStock = totalStock === 0;
        const isLowStock = totalStock > 0 && totalStock <= 3;

        // Deterministic review count based on product ID (1-10, same for all users)
        const hash = key.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        const reviewCount = (hash % 10) + 1; // Always 1 to 10

        let sizeHtml = '';
        if (isAccessory) {
            // No size selection needed, auto-select ONE
            selectedSizes[key] = 'ONE';
            const qty = (p.stock && p.stock.ONE) || 0;
            sizeHtml = qty > 0
                ? `<p style="color:#666; font-size:12px; margin-bottom:12px;">${t.oneSize}</p>`
                : `<p style="color:#999; font-size:12px; margin-bottom:12px;">—</p>`;
        } else {
            sizeHtml = `
                <button class="btn-text" onclick="openSizeGuide()">${t.sizeGuide}</button>
                <div class="size-selector" id="sizes-${key}">${renderSizeChips(key, p.stock)}</div>
            `;
        }

        // Low stock badge
        const stockBadge = isLowStock ? `<span class="stock-badge low">${t.lowStock}</span>` : '';

        // Buy button or out of stock
        let buttonsHtml = '';
        if (isOutOfStock) {
            buttonsHtml = `<button class="btn-buy btn-disabled" disabled>${t.outOfStock}</button>`;
        } else {
            buttonsHtml = `
                <div style="display: flex; gap: 8px;">
                    <button class="btn-buy" onclick="addToCart('${key}')" style="background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main);">${t.addToCart}</button>
                    <button class="btn-buy" onclick="buyItem('${key}')">${t.buyNow}</button>
                </div>
            `;
        }

        const div = document.createElement('div');
        div.className = 'product-card';
        div.innerHTML = `
            <div class="image-box">
                <img src="${imgSrc}" onerror="this.style.background='#f0f0f0'">
                ${stockBadge}
            </div>
            <div class="product-info">
                <h3>${p.name}</h3>
                <div class="review-line">
                    <span class="stars">★★★★★</span>
                    <span class="review-count">${reviewCount} ${t.reviews}</span>
                </div>
                <p class="price">${Number(p.price).toLocaleString()} ₸</p>
                ${sizeHtml}
                ${buttonsHtml}
            </div>
        `;
        grid.appendChild(div);
    });
}

function renderSizeChips(key, stock) {
    if (!stock) return "<span style='color:#999'>—</span>";
    const sizes = ['S', 'M', 'L', 'XL'];
    return sizes.map(size => {
        const qty = stock[size] || 0;
        const disabled = qty <= 0 ? 'disabled' : '';
        const onclick = qty > 0 ? `selectSize('${key}', '${size}')` : '';
        return `<div class="size-chip ${disabled}" onclick="${onclick}">${size}</div>`;
    }).join('');
}

window.selectSize = function (key, size) {
    selectedSizes[key] = size;
    const container = document.getElementById(`sizes-${key}`);
    container.querySelectorAll('.size-chip').forEach(c => c.classList.remove('selected'));
    for (let c of container.children) {
        if (c.innerText === size) c.classList.add('selected');
    }
}

// --- CART LOGIC ---
window.addToCart = function (key) {
    const t = T[currentLang || 'kz'];
    const p = productsData[key];
    const size = selectedSizes[key];

    if (!size) { alert(t.selectSize); return; }

    cart.push({
        key: key,
        name: p.name,
        price: p.price,
        size: size,
        image: p.image,
        type: p.type
    });

    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
    alert(t.addedToCart);
}

window.updateCartCount = function () {
    const badge = document.getElementById('cart-badge');
    badge.innerText = cart.length;
    badge.style.display = cart.length > 0 ? 'flex' : 'none';
}

window.openCart = function () {
    renderCart();
    document.getElementById('cart-modal').style.display = 'flex';
}

window.renderCart = function () {
    const container = document.getElementById('cart-items');
    const t = T[currentLang || 'kz'];

    if (cart.length === 0) {
        container.innerHTML = `<p style="text-align:center; padding: 20px; color: #666;">${t.emptyCart}</p>`;
        document.getElementById('cart-total-price').innerText = "0 ₸";
        return;
    }

    let total = 0;
    container.innerHTML = cart.map((item, index) => {
        total += Number(item.price);
        const imgSrc = item.image.startsWith('http') ? item.image : `images/${item.image}`;
        return `
            <div class="cart-item">
                <div style="display:flex; align-items:center;">
                    <img src="${imgSrc}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 12px;">
                    <div class="cart-item-info">
                        <h4>${item.name}</h4>
                        <p>${item.size !== 'ONE' ? item.size : t.oneSize} | ${Number(item.price).toLocaleString()} ₸</p>
                    </div>
                </div>
                <button class="btn-remove" onclick="removeFromCart(${index})">&times;</button>
            </div>
        `;
    }).join('');

    document.getElementById('cart-total-price').innerText = `${total.toLocaleString()} ₸`;
}

window.removeFromCart = function (index) {
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
    renderCart();
}

window.checkoutCart = function () {
    if (cart.length === 0) return;
    pendingOrder = [...cart]; // Copy cart items
    document.getElementById('cart-modal').style.display = 'none';
    document.getElementById('city-modal').style.display = 'flex';
}

let pendingOrder = null;

window.buyItem = function (key) {
    const p = productsData[key];
    const size = selectedSizes[key];
    const t = T[currentLang || 'kz'];

    if (!size) { alert(t.selectSize); return; }

    // pendingOrder is array even for single item
    pendingOrder = [{
        key: key,
        name: p.name,
        price: p.price,
        size: size,
        type: p.type
    }];
    document.getElementById('city-modal').style.display = 'flex';
}

window.selectCity = function (city) {
    if (!pendingOrder || pendingOrder.length === 0) return;

    // Calculate total price of items
    const itemsTotal = pendingOrder.reduce((sum, item) => sum + Number(item.price), 0);

    let shippingCost = 0;
    let shippingText = "";

    if (['Astana', 'Almaty'].includes(city)) {
        shippingCost = 1500;
        shippingText = "1 500₸";
        if (itemsTotal >= 15000) {
            shippingCost = 0;
            shippingText = "ТЕГІН/БЕСПЛАТНО";
        }
    } else if (['Karaganda', 'Shymkent', 'Aktobe'].includes(city)) {
        shippingCost = 2000;
        shippingText = "2 000₸";
    } else {
        shippingCost = 3000;
        shippingText = "2 500-3 000₸";
    }

    const t = T[currentLang || 'kz'];

    // Construct message items
    let itemsMsg = "";
    pendingOrder.forEach(item => {
        const sizeInfo = (item.type !== 'accessory' && item.size !== 'ONE') ? ` | ${t.waSize}: ${item.size}` : "";
        itemsMsg += `- ${item.name}${sizeInfo}\n  ${t.waPrice}: ${Number(item.price).toLocaleString()} ₸\n\n`;
    });

    const cityDisplay = t.cities[city] || city;

    // Create clean message without emojis to avoid encoding issues
    const msg = `${t.waGreeting}\n\n${itemsMsg}------------------\n${t.waCity}: ${cityDisplay}\n${t.waDelivery}: ${shippingText}\n${t.total}: ${(itemsTotal + shippingCost).toLocaleString()} ₸`;

    // Save order to Firebase (each item separately)
    pendingOrder.forEach(item => {
        window.db.ref('orders').push({
            item: item.name,
            productId: item.key,
            size: item.size,
            city: city,
            price: item.price,
            shipping: shippingText,
            status: 'pending',
            timestamp: new Date().toISOString()
        });
    });

    window.open(`https://wa.me/77055020133?text=${encodeURIComponent(msg)}`, '_blank');

    closeModal('city-modal');

    // If order came from cart, clear cart
    if (cart.length > 0 && JSON.stringify(cart) === JSON.stringify(pendingOrder)) {
        cart = [];
        localStorage.setItem('cart', '[]');
        updateCartCount();
        renderCart();
    }

    pendingOrder = null;
}

// --- MODALS ---
window.openSizeGuide = function (e) { if (e) e.preventDefault(); document.getElementById('size-modal').style.display = 'flex'; return false; }
window.openAbout = function (e) { if (e) e.preventDefault(); document.getElementById('about-modal').style.display = 'flex'; return false; }
window.openPrivacy = function (e) { if (e) e.preventDefault(); document.getElementById('privacy-modal').style.display = 'flex'; return false; }
window.openShipping = function (e) { if (e) e.preventDefault(); document.getElementById('shipping-modal').style.display = 'flex'; return false; }
window.openFaq = function (e) { if (e) e.preventDefault(); document.getElementById('faq-modal').style.display = 'flex'; return false; }
window.closeModal = function (id) { document.getElementById(id).style.display = 'none'; }
window.onclick = function (e) {
    ['size-modal', 'about-modal', 'lang-modal', 'privacy-modal', 'shipping-modal', 'faq-modal'].forEach(id => {
        if (e.target === document.getElementById(id)) document.getElementById(id).style.display = 'none';
    });
}
